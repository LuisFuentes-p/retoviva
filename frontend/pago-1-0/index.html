<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/favicon/favicon-96x96.png" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png" />
    <link rel="manifest" href="/assets/favicon/site.webmanifest" />
    <title>Pago 1.0 | Prototipo Viva</title>
    <link rel="stylesheet" href="../assets/css/global.css" />
    <link rel="stylesheet" href="../assets/css/payment-cart-summary.css" />
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <!-- Header superior -->
    <header class="top-header">
      <div class="container top-header-row">
        <nav class="top-links" aria-label="Navegación superior principal">
          <button type="button" class="ghost-link">Reservar</button>
          <button type="button" class="ghost-link">Información</button>
          <button type="button" class="ghost-link">Doters</button>
          <a href="../booking/" class="ghost-link is-link">Mi Reserva</a>
        </nav>
        <nav class="top-links right" aria-label="Utilidades superiores">
          <button type="button" class="ghost-link">Estatus de vuelo</button>
          <button type="button" class="ghost-link">Promociones</button>
          <button type="button" class="icon-btn" aria-label="Buscar"></button>
          <button type="button" class="ghost-link">MXN</button>
          <a href="../iniciar-sesion/" class="session-btn">Iniciar sesión</a>
        </nav>
      </div>
    </header>
    
    <!-- Header principal -->
    <header class="main-header">
      <div class="container main-header-row">
        <div class="brand-block">
          <button type="button" class="profile-btn" aria-label="Perfil"></button>
          <div>
            <a href="../" class="logo">VIVA AEROBUS</a>
            <p class="logo-sub">Pagos</p>
          </div>
        </div>
        <div class="main-actions">
          <a href="../crear-cuenta/" class="secondary-btn">Crear cuenta</a>
          <a href="../cart/" class="secondary-btn">Carrito</a>
          <a href="../booking/" class="primary-btn">Mi reserva</a>
        </div>
      </div>
    </header>

    <!-- Barra de progreso -->
    <div class="viva-progress-bar" data-current-step="6">
      <div class="viva-progress-container">
        <div class="viva-progress-steps">
          <div class="viva-step">
            <div class="viva-step-number">1</div>
            <span class="viva-step-label">Vuelos</span>
          </div>
          <div class="viva-step-line"></div>
          <div class="viva-step">
            <div class="viva-step-number">2</div>
            <span class="viva-step-label">Combos</span>
          </div>
          <div class="viva-step-line"></div>
          <div class="viva-step">
            <div class="viva-step-number">3</div>
            <span class="viva-step-label">Pasajeros</span>
          </div>
          <div class="viva-step-line"></div>
          <div class="viva-step">
            <div class="viva-step-number">4</div>
            <span class="viva-step-label">Adicionales</span>
          </div>
          <div class="viva-step-line"></div>
          <div class="viva-step">
            <div class="viva-step-number">5</div>
            <span class="viva-step-label">Asientos</span>
          </div>
          <div class="viva-step-line"></div>
          <div class="viva-step">
            <div class="viva-step-number">6</div>
            <span class="viva-step-label">Pagos</span>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
<div class="pago-1-0">
  <div class="rectangle-1"></div>
  <div class="ida">
    <img class="group-92" src="../assets/img/group-920.svg" />
    <div class="_7-00-am">
      <span>
        <span class="_7-00-am-span">7:00</span>
        <span class="_7-00-am-span2">AM</span>
      </span>
    </div>
    <div class="_10-15-am">
      <span>
        <span class="_10-15-am-span">10:15</span>
        <span class="_10-15-am-span2">AM</span>
      </span>
    </div>
    <img class="group-93" src="../assets/img/group-930.svg" />
    <div class="group-95">
      <div class="rectangle-99"></div>
      <div class="mex">MEX</div>
    </div>
    <div class="group-96">
      <div class="group-94">
        <div class="rectangle-100"></div>
      </div>
      <div class="cun">CUN</div>
    </div>
    <div class="directo">Directo</div>
    <div class="rectangle-101"></div>
    <div class="detalles">Detalles</div>
    <div class="s-b-21-feb-2026">Sáb., 21 Feb, 2026</div>
  </div>
  <div class="regreso">
    <img class="group-97" src="../assets/img/group-970.svg" />
    <div class="_6-10-am">
      <span>
        <span class="_6-10-am-span">6:10</span>
        <span class="_6-10-am-span2">AM</span>
      </span>
    </div>
    <div class="_7-35-am">
      <span>
        <span class="_7-35-am-span">7:35</span>
        <span class="_7-35-am-span2">AM</span>
      </span>
    </div>
    <img class="group-98" src="../assets/img/group-980.svg" />
    <div class="group-99">
      <div class="rectangle-992"></div>
      <div class="cun2">CUN</div>
    </div>
    <div class="group-100">
      <div class="group-94">
        <div class="rectangle-1002"></div>
      </div>
      <div class="mex2">MEX</div>
    </div>
    <div class="directo2">Directo</div>
    <div class="rectangle-102"></div>
    <div class="detalles2">Detalles</div>
    <div class="s-b-28-feb-2026">Sáb., 28 Feb, 2026</div>
  </div>
  <div class="infor">
    <div class="revisa-tu-reservaci-n">Revisa tu reservación</div>
    <div class="itinerario-de-viaje">Itinerario de viaje</div>
    <div class="ciudad-de-m-xico">Ciudad de México</div>
    <div class="canc-n">Cancún</div>
    <div class="rectangle-94"></div>
    <div class="rectangle-95"></div>
    <div class="mex3">MEX</div>
    <div class="aicm">AICM</div>
  </div>
  <div class="maleta">
    <div class="zero">Zero</div>
    <div class="group-106">
      <img class="group-105" src="../assets/img/group-1050.svg" />
      <div class="line-18"></div>
    </div>
    <div class="rectangle-107"></div>
    <div class="_1-art-culo-personal">1 artículo personal</div>
    <div class="sin-equipaje-de-mano">Sin equipaje de mano</div>
  </div>
  <div class="pasajeros3">Pasajeros</div>
  <div class="rectangle-109"></div>
  <div class="ellipse-74"></div>
  <div class="your-name">Your name</div>
  <div class="dd-mm-aaaa">DD/MM/AAAA</div>
  <div class="viaja-con-tranquilidad2">Viaja con tranquilidad</div>
  <div
    class="vuela-sin-contratiempos-con-nuestras-opciones-de-seguros-y-asistencia"
  >
    Vuela sin contratiempos con nuestras opciones de seguros y asistencia.
  </div>
  <div class="protecci-n-por-interrupci-n">
    <div class="group-107">
      <div class="rectangle-110"></div>
      <div class="rectangle-111"></div>
    </div>
    <div class="group-109">
      <div class="recomendado">Recomendado</div>
      <div class="protecci-n-por-interrupci-n-de-vuelo">
        Protección por interrupción de vuelo
      </div>
      <div
        class="si-tu-vuelo-fue-cancelado-o-tuvo-una-demora-mayor-a-2-horas-podr-s-reservar-un-nuevo-vuelo-sin-costo-a-conservar-tu-vuelo-original-y-recibir-un-reembolso-de-1-836-02-mxn"
      >
        Si tu vuelo fue cancelado o tuvo una demora mayor a 2 horas, podrás
        reservar un nuevo vuelo sin costo a conservar tu vuelo original y
        recibir un reembolso de $1,836.02 MXN
      </div>
      <div class="serviced-by">Serviced by</div>
      <div class="group-108">
        <div class="_165">+ $165</div>
        <div class="mxn">MXN |</div>
      </div>
      <div class="conoce-m-s">Conoce más</div>
    </div>
  </div>
  <div class="tarifa-reembolsable">
    <div class="group-107">
      <div class="rectangle-1102"></div>
      <div class="rectangle-1112"></div>
    </div>
    <div class="group-1092">
      <div class="recomendado2">Recomendado</div>
      <div class="tarifa-reembolsable2">Tarifa Reembolsable</div>
      <div
        class="cancela-con-total-flez-s-bilidad-hasta-24-hotas-antes-de-tu-vuelo-y-recibe-el-reembolao-en-tu-forma-de-pago-original-sin-complicaciones-ni-explicaciones-cubre-vuelo-impuestos-y-extras-disponible-solo-ahora-ltima-oportunidad"
      >
        Cancela con total flez - SÍ - bilidad hasta 24 hotas antes de tu vuelo y
        recibe el reembolao en tu forma de pago original - sin complicaciones ni
        explicaciones. Cubre vuelo, impuestos y extras. Disponible solo ahora -
        última oportunidad.
      </div>
      <div class="group-1082">
        <div class="_553">+ 553</div>
        <div class="mxn2">MXN |</div>
      </div>
      <div class="conoce-m-s2">Conoce más</div>
    </div>
  </div>
  <div class="group-110">
    <div class="rectangle-112"></div>
    <div class="rectangle-113"></div>
    <div class="viaje-sin-protecci-n2">Viaje sin protección</div>
  </div>
  <div class="rectangle-98 legacy-cart-node"></div>
  <div class="carrito-de-compra legacy-cart-node">Carrito de compra</div>
  <div class="tarifa-de-uso legacy-cart-node">
    <img class="rectangle-105" src="../assets/img/rectangle-1050.svg" />
    <div class="tarifa-de-uso-de-aeropuerto">Tarifa de Uso de Aeropuerto</div>
    <div class="tua-mex">TUA MEX</div>
    <div class="_609-00">$609.00</div>
    <div class="_351-00">$351.00</div>
    <div class="tua-cun">TUA CUN</div>
  </div>
  <div class="otros-cargos legacy-cart-node">
    <div class="rectangle-106"></div>
    <div class="otros-cargos2">Otros cargos</div>
    <div class="_1-016-00">$1,016.00</div>
    <div class="transfer">Transfer</div>
  </div>
  <div class="ida-tab legacy-cart-node">
    <div class="rectangle-103"></div>
    <div class="s-b-21-feb-07-00-am-directo">
      Sáb, 21 Feb ° 07:00 AM ° Directo
    </div>
    <div class="_1-x-tarifa-zero">1x Tarifa Zero</div>
    <div class="_1-082-66">$1,082.66</div>
    <div class="cd-m-xico-mex-canc-n-cun">Cd. México (MEX) - Cancún (CUN)</div>
  </div>
  <div class="regreso-tab legacy-cart-node">
    <div class="rectangle-104"></div>
    <div class="canc-n-cun-cd-m-xico-mex">Cancún (CUN) - Cd. México (MEX)</div>
    <div class="s-b-28-feb-06-10-am-directo">
      Sáb, 28 Feb ° 06:10 AM ° Directo
    </div>
    <div class="_1-x-tarifa-zero2">1x Tarifa Zero</div>
    <div class="_753-35">$753.35</div>
  </div>
  <div class="group-113 legacy-cart-node">
    <div class="group-112">
      <div class="rectangle-108"></div>
      <div class="total">Total</div>
      <div class="_3-813">$3,813</div>
    </div>
    <div class="impuestos-y-cargos-incluidos">Impuestos y cargos incluidos</div>
    <div class="_380-75">$380.75</div>
  </div>
  <div class="group-111 legacy-cart-node">
    <div class="rectangle-114"></div>
    <div class="cambia-a-switch-o-smart-y-pago-hasta-en-14-msi">
      Cambia a Switch o Smart y pago hasta en 14 MSI
    </div>
  </div>
  <div class="botones-container">
    <div class="rectangle-115"></div>
    <div class="regreso-btn">
      <div class="ellipse-2"></div>
      <img class="flecha-pequena" src="../assets/img/flecha-pequena-izquierda-3-1.png" alt="Regresar" />
    </div>
    <div class="continuar">
      <div class="rectangle-14"></div>
      <div class="continuar2">Continuar</div>
    </div>
  </div>
  <div class="cuadro-gris">
    <div class="rectangle-50"></div>
  </div>
  <div class="cuadro-gris2">
    <div class="rectangle-50"></div>
  </div>
  <div class="cuadro-gris3">
    <div class="rectangle-50"></div>
  </div>
  <div id="paymentCartHost" class="payment-cart-host"></div>
</div>
    </div>
  </body>
  <script src="../assets/js/payment-cart-summary.js"></script>
  <script>
    const protectionOptions = {
      interruption: { price: 165, label: 'Protección por interrupción de vuelo' },
      refundable: { price: 553, label: 'Tarifa reembolsable' },
      none: { price: 0, label: 'Viaje sin protección' },
    };

    let selectedProtection = 'none';

    function readOrder() {
      try {
        const raw = sessionStorage.getItem('flightCartOrder');
        return raw ? JSON.parse(raw) : null;
      } catch (error) {
        return null;
      }
    }

    function writeOrder(order) {
      try {
        sessionStorage.setItem('flightCartOrder', JSON.stringify(order));
      } catch (error) {
      }
    }

    function setText(selector, value) {
      const node = document.querySelector(selector);
      if (node && typeof value === 'string') {
        node.textContent = value;
      }
    }

    function setScopedText(parentSelector, childSelector, value) {
      const parent = document.querySelector(parentSelector);
      if (!parent || typeof value !== 'string') return;
      const node = parent.querySelector(childSelector);
      if (node) node.textContent = value;
    }

    function money(value) {
      return `$${Number(value || 0).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function shortCode(place) {
      const clean = String(place || '')
        .replace(/\(.*?\)/g, '')
        .replace(/[^A-Za-zÁÉÍÓÚÜÑáéíóúüñ\s]/g, ' ')
        .trim();
      if (!clean) return '---';
      const words = clean.split(/\s+/).filter(Boolean);
      if (words.length >= 2) return `${words[0][0] || ''}${words[1][0] || ''}${words[2]?.[0] || ''}`.toUpperCase();
      return clean.slice(0, 3).toUpperCase();
    }

    function formatTime12h(hhmm) {
      if (!hhmm || !hhmm.includes(':')) return '--:--';
      const [hStr, mStr] = hhmm.split(':');
      const h = Number(hStr);
      const m = Number(mStr);
      if (Number.isNaN(h) || Number.isNaN(m)) return '--:--';
      const period = h >= 12 ? 'PM' : 'AM';
      const h12 = h % 12 === 0 ? 12 : h % 12;
      return `${h12}:${String(m).padStart(2, '0')} ${period}`;
    }

    function formatDateLong(isoDate) {
      if (!isoDate) return '-';
      const d = new Date(`${isoDate}T12:00:00`);
      if (Number.isNaN(d.getTime())) return '-';
      return d.toLocaleDateString('es-MX', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' });
    }

    function computeBaseGrand(order) {
      const totals = order?.totals || {};
      const additive = Number(totals.base || 0)
        + Number(totals.tua || 0)
        + Number(totals.ground || 0)
        + Number(totals.extras || 0)
        + Number(totals.seats || 0);
      return additive > 0 ? additive : Number(totals.grand || 0);
    }

    function toggleReturnSections(showReturn) {
      const returnSelectors = ['.regreso', '.regreso-tab'];
      returnSelectors.forEach((selector) => {
        const node = document.querySelector(selector);
        if (!node) return;
        node.style.display = showReturn ? '' : 'none';
      });
    }

    function adjustCartPanelHeight() {
      const panel = document.querySelector('.rectangle-98');
      if (!panel) return;

      const selectors = [
        '.carrito-de-compra',
        '.ida-tab',
        '.regreso-tab',
        '.tarifa-de-uso',
        '.otros-cargos',
        '.group-113',
      ];

      const panelTop = panel.offsetTop;
      let maxBottom = panelTop + 846;

      selectors.forEach((selector) => {
        const node = document.querySelector(selector);
        if (!node || node.style.display === 'none') return;
        const bottom = node.offsetTop + node.offsetHeight;
        if (bottom > maxBottom) maxBottom = bottom;
      });

      panel.style.height = `${Math.max(846, maxBottom - panelTop + 28)}px`;
    }

    function renderModularCart(order, totalOverride) {
      const host = document.getElementById('paymentCartHost');
      if (!host || !window.renderPaymentCartSummary || !order) return;
      window.renderPaymentCartSummary({ root: host, order, totalOverride });
    }

    function applyProtectionVisual() {
      const map = {
        interruption: '.protecci-n-por-interrupci-n',
        refundable: '.tarifa-reembolsable',
        none: '.group-110',
      };

      document.querySelectorAll('.protecci-n-por-interrupci-n, .tarifa-reembolsable, .group-110').forEach((card) => {
        card.classList.remove('protection-selected');
      });

      const selectedNode = document.querySelector(map[selectedProtection] || map.none);
      selectedNode?.classList.add('protection-selected');
    }

    function hydrateTripInfo() {
      const order = readOrder();
      if (!order) return;

      const outbound = order.selectedOutbound;
      const incoming = order.selectedReturn;

      setScopedText('.infor', '.ciudad-de-m-xico', order.search?.origin || 'Origen');
      setScopedText('.infor', '.canc-n', order.search?.destination || 'Destino');
      setScopedText('.infor', '.mex3', shortCode(order.search?.origin));

      setScopedText('.ida', '.cun', shortCode(order.search?.destination));
      setScopedText('.regreso', '.cun2', shortCode(order.search?.destination));
      setScopedText('.regreso', '.mex2', shortCode(order.search?.origin));

      setText('.cd-m-xico-mex-canc-n-cun', `${order.search?.origin || 'Origen'} - ${order.search?.destination || 'Destino'}`);
      setText('.canc-n-cun-cd-m-xico-mex', `${order.search?.destination || 'Destino'} - ${order.search?.origin || 'Origen'}`);

      setText('._7-00-am', formatTime12h(outbound?.departTime));
      setText('._10-15-am', formatTime12h(outbound?.arriveTime));
      setText('._6-10-am', formatTime12h(incoming?.departTime));
      setText('._7-35-am', formatTime12h(incoming?.arriveTime));

      setText('.s-b-21-feb-2026', formatDateLong(order.search?.departDate));
      setText('.s-b-28-feb-2026', order.roundTrip ? formatDateLong(order.search?.returnDate) : 'Sin regreso');
      toggleReturnSections(Boolean(order.roundTrip));

      const passengerCount = Number(order.passengers || 1);
      setText('.your-name', `${passengerCount} ${passengerCount === 1 ? 'pasajero' : 'pasajeros'}`);

      const baseGrand = computeBaseGrand(order);
      const protectionPrice = protectionOptions[selectedProtection]?.price || 0;
      const payable = baseGrand + protectionPrice;

      setText('._1-016-00', money(Number(order.totals?.ground || 0) + Number(order.totals?.extras || 0)));
      setText('.transfer', order.intermodal?.label || 'Sin intermodal');
      setText('._3-813', money(payable));
      setText('._380-75', money(Number(order.totals?.tua || 0)));

      order.protection = {
        option: selectedProtection,
        label: protectionOptions[selectedProtection]?.label || protectionOptions.none.label,
        price: protectionPrice,
      };
      order.totals = order.totals || {};
      order.totals.protection = protectionPrice;
      order.totals.payable = payable;
      writeOrder(order);

      renderModularCart(order, payable);
      adjustCartPanelHeight();
    }

    const orderAtLoad = readOrder();
    if (orderAtLoad?.protection?.option && protectionOptions[orderAtLoad.protection.option]) {
      selectedProtection = orderAtLoad.protection.option;
    }
    applyProtectionVisual();
    hydrateTripInfo();

    document.addEventListener('click', function(e) {
      const interruption = e.target.closest('.protecci-n-por-interrupci-n');
      const refundable = e.target.closest('.tarifa-reembolsable');
      const none = e.target.closest('.group-110');

      if (interruption) selectedProtection = 'interruption';
      if (refundable) selectedProtection = 'refundable';
      if (none) selectedProtection = 'none';

      if (interruption || refundable || none) {
        applyProtectionVisual();
        hydrateTripInfo();
      }
    });

    const regresoBtn = document.querySelector('.regreso-btn');
    if (regresoBtn) {
      regresoBtn.addEventListener('click', function() {
        window.history.back();
      });
    }

    const continuarBtn = document.querySelector('.continuar');
    if (continuarBtn) {
      continuarBtn.addEventListener('click', function() {
        hydrateTripInfo();
        window.location.href = '../pago-1-1/';
      });
    }
  </script>
</html>
