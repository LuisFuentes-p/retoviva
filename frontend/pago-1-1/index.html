<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/favicon/favicon-96x96.png" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/assets/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png" />
    <link rel="manifest" href="/assets/favicon/site.webmanifest" />
    <title>Pago 1.1 | Prototipo Viva</title>
    <link rel="stylesheet" href="../assets/css/global.css" />
    <link rel="stylesheet" href="../assets/css/payment-cart-summary.css" />
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <!-- Header superior -->
    <header class="top-header">
      <div class="container top-header-row">
        <nav class="top-links" aria-label="Navegación superior principal">
          <button type="button" class="ghost-link">Reservar</button>
          <button type="button" class="ghost-link">Información</button>
          <button type="button" class="ghost-link">Doters</button>
          <a href="../booking/" class="ghost-link is-link">Mi Reserva</a>
        </nav>
        <nav class="top-links right" aria-label="Utilidades superiores">
          <button type="button" class="ghost-link">Estatus de vuelo</button>
          <button type="button" class="ghost-link">Promociones</button>
          <button type="button" class="icon-btn" aria-label="Buscar"></button>
          <button type="button" class="ghost-link">MXN</button>
          <a href="../iniciar-sesion/" class="session-btn">Iniciar sesión</a>
        </nav>
      </div>
    </header>

    <!-- Header principal -->
    <header class="main-header">
      <div class="container main-header-row">
        <div class="brand-block">
          <button type="button" class="profile-btn" aria-label="Perfil"></button>
          <div>
            <a href="../" class="logo">VIVA AEROBUS</a>
            <p class="logo-sub">Pagos</p>
          </div>
        </div>
        <div class="main-actions">
          <a href="../crear-cuenta/" class="secondary-btn">Crear cuenta</a>
          <a href="../cart/" class="secondary-btn">Carrito</a>
          <a href="../booking/" class="primary-btn">Mi reserva</a>
        </div>
      </div>
    </header>

    <!-- Barra de progreso -->
    <div class="viva-progress-bar" data-current-step="6">
      <div class="viva-progress-container">
        <div class="viva-progress-steps">
          <div class="viva-step">
            <div class="viva-step-number">1</div>
            <span class="viva-step-label">Vuelos</span>
          </div>
          <div class="viva-step-line"></div>
          <div class="viva-step">
            <div class="viva-step-number">2</div>
            <span class="viva-step-label">Combos</span>
          </div>
          <div class="viva-step-line"></div>
          <div class="viva-step">
            <div class="viva-step-number">3</div>
            <span class="viva-step-label">Pasajeros</span>
          </div>
          <div class="viva-step-line"></div>
          <div class="viva-step">
            <div class="viva-step-number">4</div>
            <span class="viva-step-label">Adicionales</span>
          </div>
          <div class="viva-step-line"></div>
          <div class="viva-step">
            <div class="viva-step-number">5</div>
            <span class="viva-step-label">Asientos</span>
          </div>
          <div class="viva-step-line"></div>
          <div class="viva-step">
            <div class="viva-step-number">6</div>
            <span class="viva-step-label">Pagos</span>
          </div>
        </div>
      </div>
    </div>

<div class="main-container">
<div class="pago-1-1 selected-option-1">
  <div class="rectangle-1"></div>
  <div class="rectangle-120"></div>
  <div class="ida">
    <img class="group-92" src="../assets/img/group-920.svg" />
    <div class="_7-00-am">
      <span>
        <span class="_7-00-am-span">7:00</span>
        <span class="_7-00-am-span2">AM</span>
      </span>
    </div>
    <div class="_10-15-am">
      <span>
        <span class="_10-15-am-span">10:15</span>
        <span class="_10-15-am-span2">AM</span>
      </span>
    </div>
    <img class="group-93" src="../assets/img/group-930.svg" />
    <div class="group-95">
      <div class="rectangle-99"></div>
      <div class="mex">MEX</div>
    </div>
    <div class="group-96">
      <div class="group-94">
        <div class="rectangle-100"></div>
      </div>
      <div class="cun">CUN</div>
    </div>
    <div class="directo">Directo</div>
    <div class="rectangle-101"></div>
    <div class="detalles">Detalles</div>
    <div class="s-b-21-feb-2026">Sáb., 21 Feb, 2026</div>
  </div>
  <div class="regreso">
    <img class="group-97" src="../assets/img/group-970.svg" />
    <div class="_6-10-am">
      <span>
        <span class="_6-10-am-span">6:10</span>
        <span class="_6-10-am-span2">AM</span>
      </span>
    </div>
    <div class="_7-35-am">
      <span>
        <span class="_7-35-am-span">7:35</span>
        <span class="_7-35-am-span2">AM</span>
      </span>
    </div>
    <img class="group-98" src="../assets/img/group-980.svg" />
    <div class="group-99">
      <div class="rectangle-992"></div>
      <div class="cun2">CUN</div>
    </div>
    <div class="group-100">
      <div class="group-94">
        <div class="rectangle-1002"></div>
      </div>
      <div class="mex2">MEX</div>
    </div>
    <div class="directo2">Directo</div>
    <div class="rectangle-102"></div>
    <div class="detalles2">Detalles</div>
    <div class="s-b-28-feb-2026">Sáb., 28 Feb, 2026</div>
  </div>
  <div class="infor">
    <div class="revisa-tu-reservaci-n">Revisa tu reservación</div>
    <div class="itinerario-de-viaje">Itinerario de viaje</div>
    <div class="ciudad-de-m-xico">Ciudad de México</div>
    <div class="canc-n">Cancún</div>
    <div class="rectangle-94"></div>
    <div class="rectangle-95"></div>
    <div class="mex3">MEX</div>
    <div class="aicm">AICM</div>
  </div>
  <div class="maleta">
    <div class="zero">Zero</div>
    <div class="group-106">
      <img class="group-105" src="../assets/img/group-1050.svg" />
      <div class="line-18"></div>
    </div>
    <div class="rectangle-107"></div>
    <div class="_1-art-culo-personal">1 artículo personal</div>
    <div class="sin-equipaje-de-mano">Sin equipaje de mano</div>
  </div>
  <div class="pasajeros3">Pasajeros</div>
  <div class="rectangle-109"></div>
  <div class="ellipse-74"></div>
  <div class="your-name">Your name</div>
  <div class="dd-mm-aaaa">DD/MM/AAAA</div>
  <div class="viaja-con-tranquilidad">Viaja con tranquilidad</div>
  <div class="group-115">
    <div class="rectangle-1092"></div>
    <div class="est-s-viajando-sin-protecci-n">
      Estás viajando sin protección
    </div>
  </div>
  <div class="group-116">
    <div class="rectangle-1093"></div>
    <div class="descuento-doters">Descuento Doters</div>
  </div>
  <div class="rectangle-98 legacy-cart-node"></div>
  <div class="carrito-de-compra legacy-cart-node">Carrito de compra</div>
  <div class="tarifa-de-uso legacy-cart-node">
    <img class="rectangle-105" src="../assets/img/rectangle-1050.svg" />
    <div class="tarifa-de-uso-de-aeropuerto">Tarifa de Uso de Aeropuerto</div>
    <div class="tua-mex">TUA MEX</div>
    <div class="_609-00">$609.00</div>
    <div class="_351-00">$351.00</div>
    <div class="tua-cun">TUA CUN</div>
  </div>
  <div class="otros-cargos legacy-cart-node">
    <div class="rectangle-106"></div>
    <div class="otros-cargos2">Otros cargos</div>
    <div class="_1-016-00">$1,016.00</div>
    <div class="transfer">Transfer</div>
  </div>
  <div class="ida-tab legacy-cart-node">
    <div class="rectangle-103"></div>
    <div class="s-b-21-feb-07-00-am-directo">
      Sáb, 21 Feb ° 07:00 AM ° Directo
    </div>
    <div class="_1-x-tarifa-zero">1x Tarifa Zero</div>
    <div class="_1-082-66">$1,082.66</div>
    <div class="cd-m-xico-mez-canc-n-cun">Cd. México (MEZ) - Cancún (CUN)</div>
  </div>
  <div class="regreso-tab legacy-cart-node">
    <div class="rectangle-104"></div>
    <div class="canc-n-cun-cd-m-xico-mex">Cancún (CUN) - Cd. México (MEX)</div>
    <div class="s-b-28-feb-06-10-am-directo">
      Sáb, 28 Feb ° 06:10 AM ° Directo
    </div>
    <div class="_1-x-tarifa-zero2">1x Tarifa Zero</div>
    <div class="_753-35">$753.35</div>
  </div>
  <div class="group-113 legacy-cart-node">
    <div class="group-112">
      <div class="rectangle-108"></div>
      <div class="total">Total</div>
      <div class="_3-813">$3,813</div>
    </div>
    <div class="impuestos-y-cargos-incluidos">Impuestos y cargos incluidos</div>
    <div class="_380-75">$380.75</div>
  </div>
  <div class="group-111">
    <div class="rectangle-114"></div>
    <div class="cambia-a-switch-o-smart-y-pago-hasta-en-14-msi">
      Cambia a Switch o Smart y pago hasta en 14 MSI
    </div>
  </div>
  <div
    class="vuelo-sin-contratiempos-con-nuestras-opciones-de-seguros-y-asistencia"
  >
    Vuelo sin contratiempos con nuestras opciones de seguros y asistencia.
  </div>
  <div
    class="inicia-sesi-n-o-registrate-gratis-para-mantener-tu-descuento-doters-en-esta-manera"
  >
    Inicia sesión o registrate gratis para mantener tu descuento Doters en esta
    manera.
  </div>
  <div class="rectangle-116"></div>
  <div class="iniciar-sesi-n">Iniciar sesión</div>
  <div class="formas-de-pago">Formas de pago</div>
  <div
    class="elige-cualquiera-de-las-siguientes-opciones-para-pagar-tu-reservaci-n-ten-en-cuenta-que-los-pagos-en-efectivo-no-est-n-disponibles-en-el-aeropuerto"
  >
    Elige cualquiera de las siguientes opciones para pagar tu reservación. Ten
    en cuenta que los pagos en efectivo no están disponibles en el aeropuerto.
  </div>
  <div class="rectangle-117"></div>
  <div class="rectangle-118"></div>
  <div class="maleta-de-15-kg-sin-costo-con-tu-tarjeta-hsbc-viva">
    Maleta de 15 kg sin costo con tu Tarjeta HSBC Viva
  </div>
  <div class="group-107">
    <div class="rectangle-110"></div>
    <div class="rectangle-111"></div>
  </div>
  <div class="group-109">
    <div class="tarjeta-de-cr-dito-o-d-bito">Tarjeta de crédito o débito</div>
    <div
      class="pago-de-contado-con-tu-tarjeta-preferida-si-tienes-tarjeta-digital-sala-para-pagar"
    >
      Pago de contado con tu tarjeta preferida, si tienes tarjeta digital ,
      úsala para pagar.
    </div>
    <div class="group-108">
      <div class="_4-221-30">$ 4,221.30</div>
      <div class="mxn">MXN</div>
    </div>
  </div>
  <div class="group-107">
    <div class="rectangle-1102"></div>
    <div class="rectangle-1112"></div>
  </div>
  <div class="group-1092">
    <div class="click-to-pay2">ClickToPay</div>
    <div
      class="completa-tu-pago-en-solo-unos-clics-con-click-to-pay-r-pido-simple-y-seguro"
    >
      Completa tu pago en solo unos clics con Click to Pay. Rápido, simple y
      seguro
    </div>
    <div class="group-1082">
      <div class="_4-221-302">$4,221.30</div>
      <div class="mxn2">MXN</div>
    </div>
  </div>
  <div class="group-107">
    <div class="rectangle-1103"></div>
    <div class="rectangle-1113"></div>
  </div>
  <div class="group-109">
    <div class="pago-en-efectivo-o-dep-sito-bancario">
      Pago en efectivo o depósito bancario
    </div>
    <div
      class="realiza-tu-pago-en-m-s-de-20-establecimientos-autorizados-y-miles-de-sucursales-cercano-a-ti"
    >
      Realiza tu pago en más de 20 establecimientos autorizados y miles de
      sucursales cercano a ti
    </div>
    <div class="group-1083">
      <div class="_4-189-26">$4,189.26</div>
      <div class="mxn3">MXN</div>
    </div>
  </div>
  <div class="group-107">
    <div class="rectangle-1104"></div>
    <div class="rectangle-1114"></div>
  </div>
  <div class="group-1093">
    <div class="mercado-pago2">MercadoPago</div>
    <div
      class="pago-de-manera-f-cil-y-c-moda-con-mercado-pago-cuando-completes-el-pago-no-cierres-la-pesta-a-ser-s-redirigido-aqu-para-confirmar-tu-reserva"
    >
      Pago de manera fácil y cómoda con Mercado Pago. Cuando completes el pago,
      no cierres la pestaña; serás redirigido aquí para confirmar tu reserva
    </div>
    <div class="group-1083">
      <div class="_4-189-262">$4,189.26</div>
      <div class="mxn4">MXN</div>
    </div>
  </div>
  <div class="group-107">
    <div class="rectangle-1105"></div>
    <div class="rectangle-1115"></div>
  </div>
  <div class="group-109">
    <div class="otras-formas-de-pago">Otras formas de pago</div>
    <div class="elige-un-m-todo-de-pago-en-l-nea">
      Elige un método de pago en línea
    </div>
    <div class="group-1083">
      <div class="_4-189-263">$4,189.26</div>
      <div class="mxn5">MXN</div>
    </div>
  </div>

  <button type="button" class="payment-option-hitbox option-1" data-option="1" aria-label="Seleccionar tarjeta de crédito o débito"></button>
  <button type="button" class="payment-option-hitbox option-2" data-option="2" aria-label="Seleccionar ClickToPay"></button>
  <button type="button" class="payment-option-hitbox option-3" data-option="3" aria-label="Seleccionar pago en efectivo o depósito bancario"></button>
  <button type="button" class="payment-option-hitbox option-4" data-option="4" aria-label="Seleccionar MercadoPago"></button>
  <button type="button" class="payment-option-hitbox option-5" data-option="5" aria-label="Seleccionar otras formas de pago"></button>

  <div class="pagar-con-certificado-de-vuelo">
    Pagar con certificado de vuelo
  </div>
  <div class="rectangle-119"></div>
  <div
    class="algunas-formas-de-pago-no-est-n-disponibles-por-favor-intenta-con-una-diferente"
  >
    Algunas formas de pago no están disponibles, por favor intenta con una
    diferente
  </div>
  <div class="rectangle-115"></div>
  <div
    class="acepto-comprar-los-vuelos-seleccionados-y-estoy-de-acuerdo-con-el-aviso-de-privacidad-y-los-t-rminos-y-condiciones-previmientos-le-dos"
  >
    <span>
      <span
        class="acepto-comprar-los-vuelos-seleccionados-y-estoy-de-acuerdo-con-el-aviso-de-privacidad-y-los-t-rminos-y-condiciones-previmientos-le-dos-span"
      >
        Acepto comprar los vuelos seleccionados y estoy de acuerdo con el
      </span>
      <span
        class="acepto-comprar-los-vuelos-seleccionados-y-estoy-de-acuerdo-con-el-aviso-de-privacidad-y-los-t-rminos-y-condiciones-previmientos-le-dos-span2"
      >
        aviso de privacidad
      </span>
      <span
        class="acepto-comprar-los-vuelos-seleccionados-y-estoy-de-acuerdo-con-el-aviso-de-privacidad-y-los-t-rminos-y-condiciones-previmientos-le-dos-span"
      >
        y los
      </span>
      <span
        class="acepto-comprar-los-vuelos-seleccionados-y-estoy-de-acuerdo-con-el-aviso-de-privacidad-y-los-t-rminos-y-condiciones-previmientos-le-dos-span2"
      >
        términos y condiciones
      </span>
      <span
        class="acepto-comprar-los-vuelos-seleccionados-y-estoy-de-acuerdo-con-el-aviso-de-privacidad-y-los-t-rminos-y-condiciones-previmientos-le-dos-span"
      >
        previmientos leídos.
      </span>
    </span>
  </div>
  <div class="group-118">
    <div class="_4-189-264">$4,189.26</div>
    <div class="mxn6">MXN</div>
    <div class="total-a-pagar">Total a pagar</div>
  </div>
  <div class="line-19"></div>
  <div class="botones-container">
    <div class="regreso-btn" role="button" tabindex="0" aria-label="Regresar">
      <div class="ellipse-2"></div>
      <img class="flecha-pequena" src="../assets/img/flecha-pequena-izquierda-3-1.png" alt="Regresar" />
    </div>
    <div class="continuar-btn" role="button" tabindex="0" aria-label="Continuar">
      <div class="continuar-btn-text">Continuar</div>
    </div>
  </div>
  <div class="cuadro-gris">
    <div class="rectangle-50"></div>
  </div>
  <div class="cuadro-gris2">
    <div class="rectangle-50"></div>
  </div>
  <div class="cuadro-gris3">
    <div class="rectangle-50"></div>
  </div>
  <div class="cuadro-gris4">
    <div class="rectangle-50"></div>
  </div>
  <div class="cuadro-gris5">
    <div class="rectangle-50"></div>
  </div>
  <div class="cuadro">
    <div class="rectangle-502"></div>
  </div>
  <div id="paymentCartHost" class="payment-cart-host"></div>
</div>
    </div>
  </body>

  <script src="../assets/js/payment-cart-summary.js"></script>
  <script>
    const paymentOptions = {
      1: { key: 'card', label: 'Tarjeta de crédito o débito', fee: 0 },
      2: { key: 'clicktopay', label: 'ClickToPay', fee: 0 },
      3: { key: 'cash', label: 'Pago en efectivo o depósito bancario', fee: -32.04 },
      4: { key: 'mercadopago', label: 'MercadoPago', fee: -32.04 },
      5: { key: 'other', label: 'Otras formas de pago', fee: -32.04 },
    };

    let selectedPaymentOption = 1;

    function readOrder() {
      try {
        const raw = sessionStorage.getItem('flightCartOrder');
        return raw ? JSON.parse(raw) : null;
      } catch (error) {
        return null;
      }
    }

    function writeOrder(order) {
      try {
        sessionStorage.setItem('flightCartOrder', JSON.stringify(order));
      } catch (error) {
      }
    }

    function setText(selector, value) {
      const node = document.querySelector(selector);
      if (node && typeof value === 'string') node.textContent = value;
    }

    function setScopedText(parentSelector, childSelector, value) {
      const parent = document.querySelector(parentSelector);
      if (!parent || typeof value !== 'string') return;
      const node = parent.querySelector(childSelector);
      if (node) node.textContent = value;
    }

    function money(value) {
      return `$${Number(value || 0).toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function shortCode(place) {
      const clean = String(place || '').replace(/\(.*?\)/g, '').replace(/[^A-Za-zÁÉÍÓÚÜÑáéíóúüñ\s]/g, ' ').trim();
      if (!clean) return '---';
      const words = clean.split(/\s+/).filter(Boolean);
      if (words.length >= 2) return `${words[0][0] || ''}${words[1][0] || ''}${words[2]?.[0] || ''}`.toUpperCase();
      return clean.slice(0, 3).toUpperCase();
    }

    function formatTime12h(hhmm) {
      if (!hhmm || !hhmm.includes(':')) return '--:--';
      const [hStr, mStr] = hhmm.split(':');
      const h = Number(hStr);
      const m = Number(mStr);
      if (Number.isNaN(h) || Number.isNaN(m)) return '--:--';
      const period = h >= 12 ? 'PM' : 'AM';
      const h12 = h % 12 === 0 ? 12 : h % 12;
      return `${h12}:${String(m).padStart(2, '0')} ${period}`;
    }

    function formatDateLong(isoDate) {
      if (!isoDate) return '-';
      const d = new Date(`${isoDate}T12:00:00`);
      if (Number.isNaN(d.getTime())) return '-';
      return d.toLocaleDateString('es-MX', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' });
    }

    function getBasePayable(order) {
      const totals = order?.totals || {};
      if (Number.isFinite(Number(totals.payable))) return Number(totals.payable);
      return Number(totals.grand || 0);
    }

    function optionAmount(optionNumber, basePayable) {
      const fee = paymentOptions[optionNumber]?.fee || 0;
      return basePayable + fee;
    }

    function toggleReturnSections(showReturn) {
      ['.regreso', '.regreso-tab'].forEach((selector) => {
        const node = document.querySelector(selector);
        if (!node) return;
        node.style.display = showReturn ? '' : 'none';
      });
    }

    function adjustCartPanelHeight() {
      const panel = document.querySelector('.rectangle-98');
      if (!panel) return;

      const selectors = ['.carrito-de-compra', '.ida-tab', '.regreso-tab', '.tarifa-de-uso', '.otros-cargos', '.group-113'];
      const panelTop = panel.offsetTop;
      let maxBottom = panelTop + 846;

      selectors.forEach((selector) => {
        const node = document.querySelector(selector);
        if (!node || node.style.display === 'none') return;
        const bottom = node.offsetTop + node.offsetHeight;
        if (bottom > maxBottom) maxBottom = bottom;
      });

      panel.style.height = `${Math.max(846, maxBottom - panelTop + 28)}px`;
    }

    function renderModularCart(order, totalOverride) {
      const host = document.getElementById('paymentCartHost');
      if (!host || !window.renderPaymentCartSummary || !order) return;
      window.renderPaymentCartSummary({ root: host, order, totalOverride });
    }

    function applyOptionVisual() {
      const page = document.querySelector('.pago-1-1');
      if (!page) return;
      page.classList.remove('selected-option-1', 'selected-option-2', 'selected-option-3', 'selected-option-4', 'selected-option-5');
      page.classList.add(`selected-option-${selectedPaymentOption}`);
    }

    function hydratePaymentInfo() {
      const order = readOrder();
      if (!order) return;

      const outbound = order.selectedOutbound;
      const incoming = order.selectedReturn;

      setScopedText('.infor', '.ciudad-de-m-xico', order.search?.origin || 'Origen');
      setScopedText('.infor', '.canc-n', order.search?.destination || 'Destino');
      setScopedText('.infor', '.mex3', shortCode(order.search?.origin));

      setScopedText('.ida', '.cun', shortCode(order.search?.destination));
      setScopedText('.regreso', '.cun2', shortCode(order.search?.destination));
      setScopedText('.regreso', '.mex2', shortCode(order.search?.origin));

      setText('.cd-m-xico-mez-canc-n-cun', `${order.search?.origin || 'Origen'} - ${order.search?.destination || 'Destino'}`);
      setText('.canc-n-cun-cd-m-xico-mex', `${order.search?.destination || 'Destino'} - ${order.search?.origin || 'Origen'}`);
      setText('.s-b-21-feb-2026', formatDateLong(order.search?.departDate));
      setText('.s-b-28-feb-2026', order.roundTrip ? formatDateLong(order.search?.returnDate) : 'Sin regreso');
      toggleReturnSections(Boolean(order.roundTrip));
      setText('._7-00-am', formatTime12h(outbound?.departTime));
      setText('._10-15-am', formatTime12h(outbound?.arriveTime));
      setText('._6-10-am', formatTime12h(incoming?.departTime));
      setText('._7-35-am', formatTime12h(incoming?.arriveTime));

      const passengerCount = Number(order.passengers || 1);
      const protectionLabel = String(order?.protection?.label || '').trim();
      const protectionStatus =
        protectionLabel && protectionLabel.toLowerCase() !== 'viaje sin protección'
          ? `Protección seleccionada: ${protectionLabel}`
          : 'Estás viajando sin protección';
      setText('.your-name', `${passengerCount} ${passengerCount === 1 ? 'pasajero' : 'pasajeros'}`);
      setText('.est-s-viajando-sin-protecci-n', protectionStatus);
      setText('._1-016-00', money(Number(order.totals?.ground || 0) + Number(order.totals?.extras || 0)));
      setText('.transfer', order.intermodal?.label || 'Sin intermodal');
      setText('._3-813', money(getBasePayable(order)));
      setText('._380-75', money(Number(order.totals?.tua || 0)));

      const payable = getBasePayable(order);
      const amount1 = optionAmount(1, payable);
      const amount2 = optionAmount(2, payable);
      const amount3 = optionAmount(3, payable);

      setText('._4-221-30', money(amount1));
      setText('._4-221-302', money(amount2));
      setText('._4-189-26', money(amount3));
      setText('._4-189-262', money(amount3));
      setText('._4-189-263', money(amount3));
      setText('._4-189-264', money(optionAmount(selectedPaymentOption, payable)));

      order.paymentMethod = {
        option: selectedPaymentOption,
        key: paymentOptions[selectedPaymentOption].key,
        label: paymentOptions[selectedPaymentOption].label,
        fee: paymentOptions[selectedPaymentOption].fee,
        amount: optionAmount(selectedPaymentOption, payable),
      };
      order.totals = order.totals || {};
      order.totals.final = order.paymentMethod.amount;
      writeOrder(order);

      renderModularCart(order, order.paymentMethod.amount);
      adjustCartPanelHeight();
    }

    const existingOrder = readOrder();
    if (existingOrder?.paymentMethod?.option && paymentOptions[existingOrder.paymentMethod.option]) {
      selectedPaymentOption = existingOrder.paymentMethod.option;
    }
    applyOptionVisual();
    hydratePaymentInfo();

    let isSubmittingPayment = false;

    async function submitPaymentToBackend() {
      const order = readOrder();
      if (!order) return null;

      const bookingId = Number(order?.booking?.id || order?.bookingId || 1);
      const addonsRaw = Array.isArray(order?.selectedAddons) ? order.selectedAddons : [];
      const addons = addonsRaw
        .map((value) => Number(value))
        .filter((value) => Number.isInteger(value) && value > 0);
      const promoCode = order?.promoCode || order?.promo?.code || null;

      try {
        const response = await fetch('/api/pay', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bookingId, addons, promoCode }),
        });

        const payload = await response.json().catch(() => ({}));

        order.paymentConfirmation = {
          status: response.ok ? 'ok' : 'error',
          backendMessage: payload?.message || '',
          backendTotal: Number(payload?.total || 0),
          createdAt: new Date().toISOString(),
        };

        if (response.ok && Number.isFinite(Number(payload?.total))) {
          order.totals = order.totals || {};
          order.totals.backendTotal = Number(payload.total);
        }

        writeOrder(order);
        return payload;
      } catch (_error) {
        order.paymentConfirmation = {
          status: 'error',
          backendMessage: 'No fue posible sincronizar con backend.',
          createdAt: new Date().toISOString(),
        };
        writeOrder(order);
        return null;
      }
    }

    async function proceedToConfirmation() {
      if (isSubmittingPayment) return;
      isSubmittingPayment = true;

      try {
        hydratePaymentInfo();
        await submitPaymentToBackend();
      } finally {
        isSubmittingPayment = false;
        window.location.href = '../pago-confirmado/';
      }
    }

    document.addEventListener('click', function (e) {
      const paymentOption = e.target.closest('.payment-option-hitbox');
      if (paymentOption) {
        const option = Number(paymentOption.dataset.option || '1');
        if (paymentOptions[option]) {
          selectedPaymentOption = option;
          applyOptionVisual();
          hydratePaymentInfo();
        }
      }

      const backButton = e.target.closest('.regreso-btn');
      if (backButton) {
        window.location.href = '../pago-1-0/';
      }

      const continueButton = e.target.closest('.continuar-btn');
      if (continueButton) {
        proceedToConfirmation();
      }

      const signInButton = e.target.closest('.rectangle-116, .iniciar-sesi-n');
      if (signInButton) {
        window.location.href = '../iniciar-sesion/';
      }
    });

    document.addEventListener('keydown', async function (e) {
      if (e.key !== 'Enter' && e.key !== ' ') return;

      const backButton = e.target.closest('.regreso-btn');
      if (backButton) {
        e.preventDefault();
        window.location.href = '../pago-1-0/';
      }

      const continueButton = e.target.closest('.continuar-btn');
      if (continueButton) {
        e.preventDefault();
        await proceedToConfirmation();
      }
    });
  </script>
</html>
